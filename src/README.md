# Описание проекта
Управление вентилятором в зависимости от температуры,влажности или времени. Поддерживается мониторинг и управление по протоколу MQTT.

## TODO/FEATURES
 * FETURES: Аварийный режим - включение и выключение по таймеру (например, при отсутствии датчика или wifi) 
 * TODO: Поднятие точки доступа и простого web-сервера для настройки WiFi в случае певого подключения
 * TODO: Запись настроек в EEPROM для последующего их чтения при старте.
 * TODO: Обновление прошивки по воздуху (OTA) 

## Реализуемые режимы, в порядке возрастания функциональности
-                                           // Автономный режим. Управление только по таймеру.
bool sensorAvailable                        // Молчаливый режим. Доступны показания датчика, но нет возможности контроля или управления.
-                                           // Слепой режим. Доступно управление, но нет данных с датчика.
bool controlAvailable                       // Полнофункциональный режим. Доступно управление по mqtt и есть данные с датчика.
## Доступные режимы, в порядке возрастания функциональности
|-----------------------------------------|-------------------------------------------------------------|
|(!sensorAvailable && !controlAvailable)  | Управление недоступно, датчика нет, регулировка по времени  |
|(sensorAvailable && !controlAvailable)   | Управление по датчику, mqtt не доступен                     |
|(!sensorAvailable && controlAvailable)   | Управление по mqtt, датчика нет                             |
|(sensorAvailable && controlAvailable)    | Управление вентилятором по mqtt и по показаниям датчика     |
|-----------------------------------------|-------------------------------------------------------------|




# Логика работы вентиляторов

Если найден сенсор, включить режим _offlineMode_
Если есть подходящая wifi точка, выключить режим offlineMode
  + Если установлено соединение с mqtt включить режим mqttMode


1. Инициализация порта и переменных
2. Поиск датчика. Если не найден - перейти в режим работы по таймеру.
    Если датчик найден,

3. Поиск сети в течении 10 секунд. Если не найдена - перейти в режим офлайн, иначе подключиться к сети
4. Подключение к брокеру.
5.



## Ванная комната

1. Проверить подключение датчика
2. Попытка соединиться с wifi.
  2.1. Если не удалось выполнить соединение с wifi, запустить точку доступа и создать сервер с возможностью установки параметров доступа (ssid, password).
  После успешного соединения параметры записываются в EEPROM


При включении питания вентилятор включается на startTime сек, всасывает воздух и измеряет его параметры.
При достижении заданных значений температуры и влажности включается или выключается вентилятор. Если вентилятор выключен, он периодически включается и измеряет влажность, после чего устанавливается соответствующий режим.
Также после первого запуска отправляется сообщение на сервер mqtt



Поднимается web-сервер для возможности прямого ввода значений 


## Переменные и константы
- int startTime
- int checkPeriod

- int tempOn
- int tempHisteresis
- bool tempUsing

- int humOn
- int humHisteresis
- bool humUsing

- int timeOn
- int timeHisteresis
- bool timeUsing

- int webServerLive
- bool webServerLiveUsing
- 

1. Включается питание, останавливается вентилятор
2. Устанавливается низкая скорость вентилятора
3. Производится измерение влажности
4. Устанавливается необходимая скорость вентилятора
5. Выполняется отсчет таймера repeatCycle
6. Переход к шагу 3.

### Туалет
Вентилятор включается по прошествии заданного времени. Желательно анализировать воздух.
1. Включается питание, останавливается вентилятор
2. Устанавливается низкая скорость вентилятора
3. Отсчитывается необходимый интервал времени
4. Вентилятор повышает скорость
5. Переход к шагу 3


## Дерево команд mqtt

MQTT_CMD        "fans/fan1/commands"  // Управляющие топики
MQTT_STS        "fans/fan1/states"    // Статусные топики


[dev_type].[dev_id].<commands>.[param_id]
[dev_type].[dev_id].<status>.[param_id]

RELAYS - RELAY1 - COMMANDS  - POWER: "ON/OFF"
                            - TEMP_ON:<int>
                            - TEMP_OFF:<int>
                            - HUM_ON:<int>
                            - HUM_OFF:<int>
                            - TIMER:<int>
                            - WARM:<int>


                - STATUS    - POWER: "ON/OFF"
                            - TEMPERATURE:<int>
                            - HUMIDITY:<int>

FANS - FAN1 - COMMANDS - RelayState
                       - TempOn
                       - TempOff
                       - TempUsage
            - STATE    - Temperature
                       - Hummidity
                       - RelayState
